@using Attendance_and_Leave_Management_System.DataModel
@model IEnumerable<Attendance>
@{
    ViewData["Title"] = "Attendance";
    Layout = User.IsInRole("Admin") ? "~/Views/Shared/_AdminLayout.cshtml" : "~/Views/Shared/_Layout.cshtml";
    var today = DateTime.UtcNow.Date;
    var todayRecord = Model.FirstOrDefault(a => a.Date.Date == today);
    string status;
    if (todayRecord == null)
        status = "Not Clocked In";
    else if (todayRecord.InTime != null && todayRecord.OutTime == null)
        status = $"Clocked In at {todayRecord.InTime:HH:mm}";
    else if (todayRecord.InTime != null && todayRecord.OutTime != null)
        status = $"Completed ({todayRecord.TotalHours} hrs)";
    else
        status = "Unknown";
}

<div class="container py-4">
    <h2 class="mb-4">@((User.IsInRole("Admin") ? "Admin " : "My "))Attendance</h2>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Today's Status</h5>
                    <p class="card-text fs-5">@status</p>
                    @if (TempData["AttendanceMessage"] is string msg)
                    {
                        <div class="alert alert-info py-2">@msg</div>
                    }
                    @* Only show clock actions for non-admin or allow admin to clock themselves *@
                    <div class="d-flex gap-3 mt-3">
                        <form asp-action="ClockIn" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success btn-lg" @(todayRecord != null && todayRecord.InTime != null ? "disabled" : null)>Clock In</button>
                        </form>
                        <form asp-action="ClockOut" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-danger btn-lg" @(todayRecord == null || todayRecord.OutTime != null || todayRecord.InTime == null ? "disabled" : null)>Clock Out</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="table-responsive shadow-sm">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            @if (User.IsInRole("Admin"))
                            {
                                <th>Employee Id</th>
                            }
                            <th>Date</th>
                            <th>In Time</th>
                            <th>Out Time</th>
                            <th>Total Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var item in Model.OrderByDescending(m => m.Date))
                    {
                        <tr>
                            @if (User.IsInRole("Admin"))
                            {
                                <td>@item.EmployeeId</td>
                            }
                            <td>@item.Date.ToShortDateString()</td>
                            <td>@(item.InTime.HasValue ? item.InTime.Value.ToString("HH:mm") : "-")</td>
                            <td>@(item.OutTime.HasValue ? item.OutTime.Value.ToString("HH:mm") : "-")</td>
                            <td>@(item.TotalHours > 0 ? item.TotalHours.ToString("0.00") : "-")</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>